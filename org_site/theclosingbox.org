#+hugo_base_dir: ../
#+hugo_weight: auto
#+options: author:nil
* The Closing Box
** Pages
:PROPERTIES:
:EXPORT_HUGO_SECTION: ./
:EXPORT_HUGO_CUSTOM_FRONT_MATTER: :toc false
:END:

*** about
:PROPERTIES:
:EXPORT_FILE_NAME: about
:EXPORT_DATE: 2020-05-11
:END:

Boston based.

"The correction of prose, because it has no fixed laws, is endless - a poem
comes right with a click like a closing box"
*** Blog Migration
:PROPERTIES:
:EXPORT_HUGO_SECTION: posts
:END:
**** DONE migrating the blog
:PROPERTIES:
:EXPORT_FILE_NAME: migrating-the-blog
:EXPORT_DATE: 2022-09-06
:END:

***** how was this all running?

I've been running some version of this blog for...seven years now?  I think?  I'm tremendously inconsistent, and I think no content remains from the initial version (early posts were all about work related discoveries, and I don't really have the appetite for that at the moment).  I think it has been a [[https://gohugo.io][hugo]] generated static site for the entire time, but the infrastructure has shifted underneath it a few times.

I believe that I first deployed this site to a Digital Ocean droplet running FreeBSD.  I had fallen in love with the idea of a simple to administer server with some nebulous, BSD based benefits -  "Imagine knowing exactly what every running service does!", "Oh, the user space tools are written by the same folks that write the kernel, what grand vision they must have!", etc.  I think I'd misremembered the correct parameter order for a systemd command one too many times, and was all sorts of fed up. I had experience running NGINX, and it seemed like it would tick all of the boxes, so I created the site with Hugo, and wrote some bash wrapper scripts to rsync the static site files onto the BSD droplet and reload NGINX as necessary.  The first configuration also had me manually running Let's Encrypt's certbot commands every 90 days, which was truly foolish.  Thankfully, I got that automated pretty quickly, and it's been humming along merrily ever since.

This was largely *fine*, although a bit annoying and manual to deploy, and the FreeBSD box had to be tended to differently than my other local and remote VMs.  I wasn't using BSD frequently enough to really remember what it needed and how it was all working, so every time I had to actual do anything on the box, I had to go back to notes or old terminal sessions to try to scrape together the incantations for the care and feeding of my blog host.  When I deployed [[https://www.ansible.com/products/awx-project/faq][AWX]] to automatically manage and run my ansible playbooks, I had to create a bunch of special cases to keep the BSD box happy in a sea of mostly centos and ubuntu VMs.  (AWX was its own administrative nightmare, and it seems pretty clear that IBM wants it gone...I'm not feeling particularly confident in the future of that product).

So at some point in a fit of pique, I decided I should suck it up and migrate the blog over to an OS I was using more often.  At the time, everything at work was Ubuntu based, so that's what I went with.  Migrating an NGINX and certbot config from one nix system to another is wonderfully straightforward, so with just some adjustments to my scripts, I was able to remove the BSD induced administrative headache without too much trouble.

At some point, I decided that the blog I never update that nobody reads definitely needs a CDN (I mean, what if the blog posts that I don't write end up being shared far and wide on social media platforms that I don't use or interact with?  That's definitely a thing that could happen, and a normal person should absolutely spend their precious time on this earth configuring that).  Cloudflare's free tier seemed to tick all the boxes, and they have a nice developer onboarding experience, so without much more ado the Digital Ocean droplet was now fronted by a CDN.

***** what's changed?

I've been feeling a little gross about Cloudflare of late (for obvious reasons), and I'm also feeling like I've been wasting money paying for a droplet that just requires me to spend more of my time managing it.  So I thought I would close my Cloudflare account, migrate my site to one of the static site hosting services and stop spending my time administering the server itself.  I'm not getting anything out of running it myself; I know how to run a nix box, I know how to run NGINX...and there's nothing valuable to me in making myself do it.  Rather than set up a deployment pipeline of my own (I've got some new pipelines setup for my internal home proxy, which has been pretty cool), I decided to use a static site hosting service with a generous free tier.

I had heard a bit about [[http://www.render.com
][Render]] on a discord server that I hang out on, so I thought it could be worth a try.  (Folks that know about Render can probably spot a big ol' ironic twist waiting in the wings).  So I moved my site from Gitlab (where I keep private things) to Github (and in the process finally settled on my new, clean, Github account, and sunset the almost decade old, semi-used account I had half set up in the past), and got it slurped up into Render.  Everything looked good, so I made the DNS changes with my registrar, and boom! A new static site looking exactly like the old one.  But with a much lower maintenance requirement, and a more pleasant writing/deploying experience.

Out of curiosity, I thought I'd look at the issued cert, just to see what kind of setup they've got in place.  Low and behold, Render farms that all out...to Cloudflare.  Bummer. Looking at their documentation, they're quite up front about the whole thing, but I must have missed it when I glanced through.  A testament to their dev experience generally, I didn't really need to dive deep into the docs.  I'm going back and forth on whether or not it makes sense to move the site again;  I've accomplished a few of my goals (reduced cost and maintenance burden, more pleasant deployments), but I haven't managed to fully extricate myself from a company I find kind of gross.

All told, I'd consider this to be a middling success.  I'm happy to make it easier to write here, glad that I'm not paying for the privilege of admining a linux box for the millionth time, and a little bummed that I'm only one step removed from doing business with a company I'd rather avoid.

*** Home Rack Rebuild
:PROPERTIES:
:EXPORT_HUGO_SECTION: posts
:END:
**** DONE home rack rebuild plan
:PROPERTIES:
:EXPORT_FILE_NAME: home-rack-rebuild-plan
:EXPORT_DATE: 2021-05-30
:END:

***** what's the problem?

My virtualization lab, networking gear, NAS and AV backbone is an absolute mess.  The current 12u server rack is full, the 6u network rack has stuff sitting not just in it but on top of it, and it's all a real mess down there.  Lots of wasted space, awkward network and power runs, and poor use of the large mesh storage shelves in that area.  I'd like to store other stuff in that space, and sitting the 6u rack unit on top of wire mesh shelves with printer/AV equipment underneath just doesn't work.

The space is an unfinished portion of the basement that used to house our washer and dryer.  Since we moved them up into the second floor laundry closet earlier this year, I've got a bunch of extra floor space to properly rearrange the equipment.  That area is a great storage spot, with easy outdoor access, so maximizing shelf space is a priority.  Getting all equipment into a rack or onto a permanent shelf, and keeping the shelves as accessible as possible are my two guiding principles.

You can see in the original floorplan drawing how awkward the layout is.

#+CAPTION: A rough outline of the original floorplan
file:/images/floorplanbefore.jpg



***** failed solutions

****** 42u or bust
My first thought was to collapse it all down into one large rack.  A 42u rack would fit everything that I have, with room to grow.  This has some great benefits around easier power and network runs (running within a single rack is *way* easier than cleanly running outside).

Unfortunately, a 42u rack needs 78" (well, more precisely it needs 72.1875" plus whatever is required for the rack's structure) of vertical clearance.  From poured slab to first floor joist, I've got 79", but plumbing runs more than an inch below anywhere that I'd like to actually stick this rack.  I could stick a 42u rack in another portion of the basement, but that would be less than ideal (suddenly, I'm solving the sliding tile puzzle of emptying another portion out before I can even start.  No way).  So we'll have to go shorter.

****** square pegs in round holes
Not all of the equipment that I have is really rack mountable.  The [[https://www.hp.com/us-en/shop/pdp/hp-color-laserjet-pro-m255dw#!][printer]] and [[https://www.playstation.com/en-us/ps5/?smcid=pdc%3Aen-us%3Aprimary%20nav%3Amsg-hardware%3Aps5][PS5]] are really not workable in a rack mount; the printer would take up way too much space, and need a pull out shelf to be useful.  The PS5 just doesn't fit right in a rack (or anywhere, really).  The [[http://www.xbox.com/en-US/xbox-one-x][Xbox One X]] could rack mount pretty cleanly in a 2u shelf, but since I need to keep a separate AV shelf anyway, let's keep the PS5 and Xbox One X together, alongside the printer.  I'll lose one shelf on my mesh shelves, but such is life.  The wire shelf unit can stay where it is, and dedicate one shelf to printer + consoles.  A single [[https://store.ui.com/collections/unifi-network-switching/products/usw-lite-16-poe][Ubiquiti switch lite 16 PoE]] will deal with networking, and I'll run two HDMI 2.0 cables along the ceiling to the HDMI matrix.

****** have less computer stuff

No.

***** solution

Add a 25u rack, positioned immediately to the left when walking into the raised basement area.  Put the 12u rack, currently floating in front of three shelving units and blocking access, to the right of the 25u rack.  The 8 shelf metal wire shelving unit currently on the opposite side of the basement can go against the wall next to the outside door.  The two existing metal shelves can stay in place, and the white cube units can also stay where they are for now.  All will be accessible again once the rack units are out of the way.

So the new floor plan will be something like:

#+CAPTION: So much room for activities!
file:/images/floorplanafter.jpg





***** what's in the rack?

Both of these racks have variable depth, which is useful if I ever want to lose my mind and mount units to the front and back.
I'll plan to set them to their shallowest setting, since all of my equipment fits in that.
They're both open topped, but once they're in place I'll likely cut down some plywood to make the tops work surfaces.

****** r1 - 25u rack

r1 is a [[https://www.amazon.com/gp/product/B00O6GNLQE/ref=ppx_yo_dt_b_asin_title_o01_s01?ie=UTF8&psc=1][StarTech 25U Open Frame Server Rack]]

Drawn out, it should look like:
#+CAPTION: 25u Rack, r1
file:/images/r1.jpg

And in table form with links:

| Rack unit | Contents                                                                |
|-----------+-------------------------------------------------------------------------|
|        25 | E1,[[https://www.amazon.com/gp/product/B0035PS5AE/ref=ppx_yo_dt_b_asin_title_o01_s00?ie=UTF8&psc=1][ Startech 8 outlet 1u PDU]]                                            |
|        24 | hdmi.iot.,  [[https://www.amazon.com/gp/product/B01GKFQNG8/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][HDMI Matrix]]                                                 |
|        23 | Basement Rack 8 ([[https://store.ui.com/collections/unifi-network-switching/products/unifi-switch-8-150w][UB US-8-150w)]], vesta.internal. ([[https://www.amazon.com/gp/product/B07V5JTMV9/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][RPi 4]], with [[https://www.thingiverse.com/thing:4746666][this case]]) |
|        22 | P1, [[https://www.amazon.com/gp/product/B0072JVT02/ref=ppx_yo_dt_b_asin_title_o01_s03?ie=UTF8&psc=1][Cable Matters 24 port keystone patch panel]]                          |
|        21 | Basement Rack 24, [[https://store.ui.com/collections/unifi-network-switching/products/usw-pro-24][UB USW-Pro-24]]                                         |
|        20 | P2, [[https://www.amazon.com/gp/product/B0072JVT02/ref=ppx_yo_dt_b_asin_title_o01_s03?ie=UTF8&psc=1][Cable Matters 24 port keystone patch panel]]                          |
|        19 | Core,  [[https://store.ui.com/collections/unifi-network-switching/products/unifi-switch-16-xg][UB US-16-XG]]                                                      |
|        18 | UDM,  [[https://store.ui.com/collections/unifi-network-unifi-os-consoles/products/udm-pro][UDM Pro]]                                                           |
|        17 | cerberus.internal., [[https://support.apple.com/kb/sp632?locale=en_US][Mac Mini, 2011]],                                     |
|        16 |                                                                         |
|        15 | [[https://www.amazon.com/gp/product/B07GX59NY8/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][Intel NUC (Proxmox02)]], [[https://www.apple.com/apple-tv-hd/specs/][Apple TV HD]], [[https://www.philips-hue.com/en-us/p/hue-bridge/046677458478][Hue Bridge]]                          |
|        14 | E2, [[https://www.amazon.com/gp/product/B00077INZU/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][CyberPower 12 Outlet Surge Protector]]                                |
|        13 |                                                                         |
|        12 | [[https://www.amazon.com/gp/product/B009WS7TSW/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][2U Rack Drawer]]                                                          |
|        11 |                                                                         |
|        10 |                                                                         |
|         9 | [[https://www.behringer.com/product.html?modelCode=P0AWN][X32 Rack]]                                                                |
|         8 |                                                                         |
|         7 |                                                                         |
|         6 |                                                                         |
|         5 | [[https://www.amazon.com/gp/product/B009WS7S1A/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][4U Rack Drawer]]                                                          |
|         4 |                                                                         |
|         3 |                                                                         |
|         2 |                                                                         |
|         1 | [[https://www.amazon.com/gp/product/B00Q2Z11QE/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][Proxmox03]]                                                               |


****** r2 - 12u rack



r2 is a [[https://www.amazon.com/gp/product/B00P1RJ9LS/ref=ppx_yo_dt_b_asin_title_o01_s01?ie=UTF8&th=1][StarTech 12U Open Frame Server Rack]].

A quick sketch of the unit once filled:
#+CAPTION: 12u Rack, r2
file:/images/r2.jpg

And in table form with links:

| Rack unit | Contents                                       |
|-----------+------------------------------------------------|
|        12 | E3, [[https://www.amazon.com/gp/product/B00077INZU/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][CyberPower 12 Outlet Surge Protector]]       |
|        11 | P3, [[https://www.amazon.com/gp/product/B0072JVT02/ref=ppx_yo_dt_b_asin_title_o01_s03?ie=UTF8&psc=1][Cable Matters 24 port keystone patch panel]] |
|        10 |                                                |
|         9 | [[https://www.amazon.com/gp/product/B009WS7TSW/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][2U Rack Drawer]]                                 |
|         8 |                                                |
|         7 |                                                |
|         6 |                                                |
|         5 | [[https://www.silverstonetek.com/product.php?pid=488][Proxmox01]]                                      |
|         4 |                                                |
|         3 |                                                |
|         2 |                                                |
|         1 | [[https://www.amazon.com/gp/product/B0055EV30W/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1][janus.internal.]]                                |


****** pdu mapping

I don't have rack mountable UPS's yet, which is a bit of a bummer. The tower models that I've got will have to do; upstream of e1+e2 will be one Cyberpower tower UPS, and upstream of e3 will be the second.

******* e1 - PDU at r1.25

e1 has 8 rear facing plugs.

| name | plug 1        | plug 2      | plug 3     | plug 4       | plug 5         | plug 6     | plug 7          | plug 8  |
|------+---------------+-------------+------------+--------------+----------------+------------+-----------------+---------|
| e1   | matrix, r1.24 | UB 8, r1.23 | RPi, r1.23 | UB 24, r1.21 | UB Core, r1.19 | UDM, r1.18 | Cerberus, r1.17 | (empty) |

******* e2 - PDU at r1.14

e2 has only 6 rear facing plugs.  I have this PDU already, and the 6 externally facing plugs might be useful for one off/quick plugins.

| name | plug 1           | plug 2          | plug 3     | plug 4    | plug 5          | plug 6  |
|------+------------------+-----------------+------------+-----------+-----------------+---------|
| e2   | Proxmox02, r1.15 | Apple TV, r1.15 | Hue, r1.15 | X32, r1.9 | Proxmox03, r1.1 | (empty) |

******* e3 - PDU at r2.12

e3 is identical to e2, and again benefits from me already owning it.

| name | plug 1      | plug 2          | plug 3  | plug 4  | plug 5  | plug 6  |
|------+-------------+-----------------+---------+---------+---------+---------|
| e3   | Janus, r2.1 | Proxmox01, r2.5 | (empty) | (empty) | (empty) | (empty) |


****** patch panel mapping

I really like these keystone patch panels.  I made the mistake of punching down the patch panel in my current 6u network rack; it was a tremendous waste of time,
and the second I wanted to change something I regretted the configuration.  Cat6 keystones are definitely the way to go.


******* p1 - patch panel at r1.22

| port number | in (behind)                        | out (front)   |
|-------------+------------------------------------+---------------|
|           1 | 1st Floor Switch (out of rack)     | UB 8 port 1   |
|           2 | Basement AP  (out of rack)         | UB 8 port 2   |
|           3 | Octoprint RPi server (out of rack) | UB 8 port 3   |
|           4 | Matrix r1.25                       | UB 24 port 3  |
|           5 | Rpi loop p1.24                     | UB 24 port 4  |
|           6 | Mac Mini r1.17                     | UB 24 port 5  |
|           7 | Hue, r1.15                         | UB 24 port 6  |
|           8 | Proxmox02, r1.15                   | UB 24 port 7  |
|           9 | Apple TV, r1.15                    | UB 24 port 8  |
|          10 | X32, r1.9                          | UB 24 port 9  |
|          11 | X32, r1.9                          | UB 24 port 10 |
|          12 | X32, r1.9                          | UB 24 port 11 |
|          13 | Proxmox03, r1.1                    | UB 24 port 12 |
|          14 | Proxmox01, r2.11, p3.8             | UB 24 port 13 |
|          15 | Janus, r2.11, p3.2                 | UB 24 port 14 |
|          16 | Basement Switch                    | UB 24 port 15 |
|          17 | AV Switch (out of rack)            | UB 24 port 16 |
|          18 | (empty)                            | (empty)       |
|          19 | (empty)                            | (empty)       |
|          20 | (empty)                            | (empty)       |
|          21 | (empty)                            | (empty)       |
|          22 | (empty)                            | (empty)       |
|          23 | (empty)                            | (empty)       |
|          24 | Rpi loop p1.5                      | RPi,  r1.23   |

******* p2 - patch panel at r1.20

| port number | in (behind)                   | out (front)         |
|-------------+-------------------------------+---------------------|
|           1 | Proxmox03, p1.1               | Core port 1         |
|           2 | Proxmox03, p1.1               | Core port 3         |
|           3 | Proxmox01, p2.11, p3.10       | Core port 4         |
|           4 | Proxmox01, p2.11, p3.12       | Core port 5         |
|           5 | Janus, r2.11, p3.4            | Core port 6         |
|           6 | Janus, r2.11, p3.6            | Core port 7         |
|           7 | (empty)                       | (empty)             |
|           8 | (empty)                       | (empty)             |
|           9 | (empty)                       | (empty)             |
|          10 | (empty)                       | (empty)             |
|          11 | (empty)                       | (empty)             |
|          12 | (empty)                       | (empty)             |
|          13 | (empty)                       | (empty)             |
|          14 | (empty)                       | (empty)             |
|          15 | (empty)                       | (empty)             |
|          16 | (empty)                       | (empty)             |
|          17 | (empty)                       | (empty)             |
|          18 | (empty)                       | (empty)             |
|          19 | (empty)                       | (empty)             |
|          20 | (empty)                       | (empty)             |
|          21 | (empty)                       | (empty)             |
|          22 | (empty)                       | (empty)             |
|          23 | (empty)                       | (empty)             |
|          24 | WAN, Verizon ONT (out of rack) | UDM WAN port, r1.18 |

******* p3 - patch panel at r2.11

| port number | in (behind)          | out (front)  |
|-------------+----------------------+--------------|
|           1 | Janus.1g, p2.1       | Loop to p3.2 |
|           2 | r1.22, p1.15         | Loop to p3.1 |
|           3 | Janus.10g1, p2.1     | Loop to p3.4 |
|           4 | r1.20, p2.5          | Loop to p3.3 |
|           5 | Janus.10g2, p2.1     | Loop to p3.6 |
|           6 | r1.20, p2.6          | Loop to p3.5 |
|           7 | Proxmox01.1g, p2.5   | Loop to p3.8 |
|           8 | r1.22, p1.14         | Loop to 3.7  |
|           9 | Proxmox01.10g1, p2.5 | Loop to 3.10 |
|          10 | r1.20, p2.3          | Loop to 3.9  |
|          11 | Proxmox01.10g2, p2.5 | Loop to 3.12 |
|          12 | r1.20, p2.4          | Loop to 3.11 |
|          13 | (empty)              | (empty)      |
|          14 | (empty)              | (empty)      |
|          15 | (empty)              | (empty)      |
|          16 | (empty)              | (empty)      |
|          17 | (empty)              | (empty)      |
|          18 | (empty)              | (empty)      |
|          19 | (empty)              | (empty)      |
|          20 | (empty)              | (empty)      |
|          21 | (empty)              | (empty)      |
|          22 | (empty)              | (empty)      |
|          23 | (empty)              | (empty)      |
|          24 | (empty)              | (empty)      |


****** switch mapping

Three primary switches in this rack.  =us-8-150w= deals with all things PoE.  =usw-pro-24= acts as the primary 1gig switch, and =us-16-xg= sits in as the core 10gig switch.

******* us-8-150w

| port | connection        | vlan  | notes                 |
|------+-------------------+-------+-----------------------|
|    1 | r1.22, p1.1 front | LAN   | PoE                   |
|    2 | r1.22, p1.2 front | LAN   | PoE                   |
|    3 | r1.22, p1.3 front | LAN   | PoE                   |
|    3 | (empty)           |       |                       |
|    4 | (empty)           |       |                       |
|    5 | (empty)           |       |                       |
|    6 | (empty)           |       |                       |
|    7 | (empty)           |       |                       |
|    8 | (empty)           |       |                       |
| sfp1 | r1.21  port 1     | trunk | SFP to RJ45, LAG sfp2 |
| sfp2 | r1.21 port 2      | trunk | SFP to RJ45, LAG sfp1 |

******* usw-pro-24

|  port | connection      | vlan  | notes                  |
|-------+-----------------+-------+------------------------|
|     1 | r1.23 port sfp1 | trunk | LAG port 2             |
|     2 | r1.23 port sfp2 | trunk | LAG port 1             |
|     3 | r1.22 p1.4      | IoT   |                        |
|     4 | r1.22 p1.5      | LAN   |                        |
|     5 | r1.22 p1.6      | LAN   |                        |
|     6 | r1.22 p1.7      | LAN   |                        |
|     7 | r1.22 p1.8      | LAN   |                        |
|     8 | r1.22 p1.9      | LAN   |                        |
|     9 | r1.22 p1.10     | LAN   | control for X32        |
|    10 | r1.22 p1.11     | dante | x-dante card           |
|    11 | r1.22 p1.12     | dante | x-dante card           |
|    12 | r1.22 p1.13     | LAN   |                        |
|    13 | r1.22 p1.14     | LAN   |                        |
|    14 | r1.22 p1.15     | LAN   |                        |
|    15 | r1.22 p1.16     | trunk | downstream to office   |
|    16 | r1.22 p1.17     | LAN   | downstream to AV shelf |
|    17 | (empty)         |       |                        |
|    18 | (empty)         |       |                        |
|    19 | (empty)         |       |                        |
|    20 | (empty)         |       |                        |
|    21 | (empty)         |       |                        |
|    22 | (empty)         |       |                        |
|    23 | (empty)         |       |                        |
|    24 | (empty)         |       |                        |
| sfp+1 | r1.19 port 11   | trunk | DAC, LAG with sfp+2    |
| sfp+2 | r1.19 port 12   | trunk | DAC, LAG with sfp+1    |

******* us-16-xg

| port | connection             | vlan  | notes                          |
|------+------------------------+-------+--------------------------------|
|    1 | r1.20, p2.1            | lab   | SFP+ to RJ45                   |
|    2 | Attic sfp, out of rack | trunk | SFP                            |
|    3 | r1.20 p2.2             | lab   | SFP+ to RJ45                   |
|    4 | r1.20 p2.3             | lab   | SFP+ to RJ45                   |
|    5 | r1.20 p2.4             | lab   | SFP+ to RJ45                   |
|    6 | r1.20 p2.5             | LAN   | SFP+ to RJ45 (LAN NAS service) |
|    7 | r1.20 p2.6             | lab   | SFP+ to RJ45                   |
|    8 | r1.18 UDM pro SFP+ LAN | trunk | DAC, STP blocked               |
|    9 | (empty)                |       |                                |
|   10 | (empty)                |       |                                |
|   11 | r1.21, port sfp+1      | trunk | DAC, LAG with 12               |
|   12 | r1.21, port sfp+2      | trunk | DAC, LAG with 11               |
|   13 | (empty)                |       |                                |
|   14 | (empty)                |       |                                |
|   15 | (empty)                |       |                                |
|   16 | r1.18 UDM pro RJ45 LAN | trunk |  Redundant with port 8         |


****** hdmi matrix mapping

I love this lunatic device.  Being able to reprogram display flows is so much fun, and the flexibility to easily share any device remotely with folks via the matrix/Atem Mini Extreme combo is down right magical.

Input mapping is mostly reliant on out of rack cables.  The Apple TV and Proxmox01 (windows 10 gaming VM with passthrough GPU) inputs are both in rack, and the consoles will both need slightly longer cables
since the matrix is moving off of the shelf that they currently live in.  The rest is in my big desk HDMI bundle, coming in through the ceiling.

| port   | connection                          | edid                        |
|--------+-------------------------------------+-----------------------------|
| HDMI 1 | Desktop, nvidia 1070 HDMI out       | 1080p HD Audio 7.1          |
| HDMI 2 | m1 MacMini HDMI out                 | 1080p HD Audio 7.1          |
| HDMI 3 | Desk HDMI cable                     | 1080p HD Audio 7.1          |
| HDMI 4 | Proxmox01 RX580 hdmi out (win01 vm) | 1080p HD Audio 7.1          |
| HDMI 5 | PS5                                 | COPY_FROM_OUT_1 (4k60,444)  |
| HDMI 6 | XboxOneX                            | COPY_FROM_OUT_1 (4k60, 444) |
| HDMI 7 | Apple TV                            | 1080p HD Audio 7.1          |
| HDMI 8 | Atem Mini Extreme Output 1          | 1080p HD Audio 7.1          |


Output mapping is entirely out of rack at the moment.  I'll move my HDMI bundle over pretty much unchanged.

| port     | connection                | scaler mode |
|----------+---------------------------+-------------|
| Output 1 | [[https://www.dell.com/en-us/work/shop/dell-ultrasharp-27-4k-hdr-monitor-up2718q/apd/210-amvp/monitors-monitor-accessories][Desk Dell Ultrasharp]]      | Bypass      |
| Output 2 | [[https://us.aoc.com/en/gaming-monitors/c24g1][Desk AOC Monitor]]          | Auto        |
| Output 3 | [[http://www.feelworld.cn/ShowInfo.aspx?id=530&py=FEELWORLD-T7-7-4K-On-camera-Monitor-with-HDMI-Input-Output-IPS-1920x1200-Rugged-Aluminum-Housing][Camera Mount Feelworld 4k]] | Auto        |
| Output 4 | (empty)                   | (empty)     |
| Output 5 | Atem Mini Extreme input 5 | AUTO        |
| Output 6 | Atem Mini Extreme input 6 | AUTO        |
| Output 7 | (empty)                   | (empty)     |
| Output 8 | (empty)                   | (empty)     |


Loopout HDMI port mapping:

| port   | device          | connection                |
|--------+-----------------+---------------------------|
| loop 1 | Desktop         | (empty)                   |
| loop 2 | MacMini         | (empty)                   |
| loop 3 | Desk HDMI cable | Atem Mini Extreme input 7 |
| loop 4 | Win01           | (empty)                   |
| loop 5 | PS5             | (empty)                   |
| loop 6 | Xbone           | (empty)                   |
| loop 7 | Apple TV        | Atem Mini Extreme input 8 |
| loop 8 | AtemOut         | (empty)                   |


Courtesy of the analog audio outputs, I can get audio flows into the Behringer and onto the Dante network.  This lets me reprogam audio even more dynamically than video, sending buses anywhere I need along the Dante network.  So here we'll have two 3.5mm to dual 1/4 inch cables running down from the matrix into the X32 rack.

Analog audio output mapping from the matrix:

| port  | output device        | connection                             |
|-------+----------------------+----------------------------------------|
| aux 1 | Desk Dell Ultrasharp | x32 Aux 1 + 2 (3.5mm to dual 1/4 inch) |
| aux 2 | Desk AOC Monitor     | x32 Aux 3 + 4 (3.5mm to dual 1/4 inch) |
| aux 3 | Feelworld            | (empty)                                |
| aux 4 | (empty)              | (empty)                                |
| aux 5 | Atem Input 5         | (empty)                                |
| aux 6 | Atem Input 6         | (empty)                                |
| aux 7 | (empty)              | (empty)                                |
| aux 8 | (empty)              | (empty)                                |

***** what's next?

I think that's the plan.  It doesn't rely on me adding a whole bunch of new equipment (the only new stuff is the 25u rack, one more patch panel and a third PDU), and it should have some space for me to rearrange things and expand (the drawers can come out in the future, the fractal design case can be collapsed down into 2u)

If I've totally whiffed on something, let me know! If all goes well, I should be able to make the switch next weekend.  I'll document the process, and hopefully when next I write, it will be with a newly reorganized home rack!

*** Mac Pro Build Log                                     :@macprobuildlog:
:PROPERTIES:
:EXPORT_HUGO_SECTION: posts
:END:

**** TODO macpro build - day 5
:PROPERTIES:
:EXPORT_FILE_NAME: mac-pro-buildlog-07
:EXPORT_DATE: 2020-09-15
:END:


**** DONE macpro build - day 4
:PROPERTIES:
:EXPORT_FILE_NAME: mac-pro-buildlog-06
:EXPORT_DATE: 2020-08-30
:END:

With the PCI slots sorted out, it's time to turn to the processor tray.  This
was well trodden territory - upgrading the memory in the 5,1 Mac Pro was
something almost everyone did (Apple's memory prices are...rough, to say the
least), and I remember the CPU replacement process dimly from my days in the
blue t-shirt (the ridiculously long hex driver has a special place in my
heart).

We've got two things on the docket for us to work on.  First, I'm going to remove the old pair of quad core processors and pop in our fancy pair of hexacore processors.  Second, I'll remove the current batch of memory sticks at drop in a truly absurd sextet of 16 gig DDR3 1333 MHz DIMMs.  This would also be a good time to upgrade the bluetooth and wifi cards, if I were so inclined.  The bluetooth upgrade to support handoff/watch unlock is pretty tempting, so I might return to this at a future date, but this is not a machine that I'll be using on wifi.  I've got ethernet available anywhere that I would want to drop this Mac Pro, and I will always choose wired over wireless. For now, I'll leave the airport and bluetooth cards untouched.

***** processors and memory

First things first - let's look at our new processors

#+CAPTION: A Pair of Xeon 5690 (32 nm 6 core, 12 thread 3.46 GHz)
file:/images/mp_17.jpg

Removing the tray is simple enough.  The edges are sharp, so I recommend being careful here. Keep the tray level, and be ready for it to be a bit heavier than you might expect.

#+CAPTION: The dual processor tray sliding out
file:/images/mp_18.jpg

Threading the long shanked torx driver through the heatsink can be tough.  I find it useful to take a look from the side to get a clearer sense of how the shank gaps all stack on top of each other.  Loosen the retaining screws in a cross pattern, a bit at a time to try to keep the heatsink level.

#+CAPTION: You can just see how the long torx driver reaches through the heatsink
file:/images/mp_19.jpg

The thermal paste is likely a full decade old at this point.  What is that, a 4th grader?  Something like that?  It cleans up easily with some isopropyl alcohol and a few Q-tips.

#+CAPTION: Ten year old thermal paste
file:/images/mp_20.jpg

#+CAPTION: Cleans right off
file:/images/mp_21.jpg

The retaining clips are nice and easy, and dropping the new processors into place is a straightforward affair as well.  Apply some new thermal paste, pop the heatsinks back on, and we're ready to move on to memory.

#+CAPTION: New processors, ready to roll
file:/images/mp_22.jpg

As I said before, almost every owner of a Mac with user serviceable RAM ended up tossing in a third-party stick or two.  The only trick here is that we need to make sure that we're running in triple channel memory mode, so I'll deliberately leave one slot empty (slots 4 and 8, to be specific).  One 16 gig DIMM in slots 1-3 and 5-7 will leave us with 96 GB of memory to play with.

And the blue is a great color.

#+CAPTION: Blue definitely means it runs cooler.
file:/images/mp_23.jpg

***** performance

With some healthy upgrades in place, let's try to some synthetic benchmarks to see how far we've come.

As a reminder, our baseline compute performance, with 2 quad core 2.4 GHz processors and 16 gigs of 1066 MHz memory looked like this:

| Benchmark                    | Result |
|------------------------------+--------|
| Geekbench 5 CPU, Single Core |    485 |
| Geekbench 5 CPU, Multi Core  |   3160 |
| Cinebench                    |   1640 |


With the dual six core processors and the faster memory, we're now sitting at:

| Benchmark                    | Result | Delta     |
|------------------------------+--------+-----------|
| Geekbench 5 CPU, Single Core |    641 | +  %32.16 |
| Geekbench 5 CPU, Multi Core  |   6412 | + %102.91 |
| Cinebench                    |   3090 | +  %88.41 |

Our new Cinebench score puts us somewhere just below the AMD Ryzen 7 1700X and the Intel Xeon E5-2697 v2,  and handily above the Intel I7-7700k for multicore performance.


***** bluray

Let's round the day out by replacing the optical drive.  Another straightforward one, with one small wrinkle.  I already had a  LG WH16NS60 16x Internal Blu-ray BDXL M-Disc Drive, flashed for UHD rips in an OWC enclosure that I had been using to back up my media.  I pulled the Blu-ray drive
out of the OWC enclosure without issue.  I removed the original DVD drive from the Mac Pro (the enclosure slides out
when drive bays are unlocked, and 4 phillips screws are all that's left to remove the optical drive).  I elected
to replace, rather than supplement the existing DVD drive; I don't think there
are circumstances wherein I'd want a DVD and a Blu-ray drive.  If I find myself
ripping a season or two of Blu-rays again, I could always put a second Blu-ray
drive in there, and run two instances of MakeMKV (I think - that might be worth testing at some point.  I don't know that it can simultaneously address two optical drives).

The one small wrinkle - with the original front plastic plate on the new Blu-ray drive, it would not fit
through the Mac Pro case's small frontal slot.  Luckily, it was simple to pop off the plastic front plate of the Blu-ray drive with a blackstick, and now the drive seems to work just fine.



**** DONE  macpro build - day 3
:PROPERTIES:
:EXPORT_FILE_NAME: mac-pro-buildlog-05
:EXPORT_DATE: 2020-08-29
:END:

Day three, fittingly enough, is all about Thunderbolt 3.  This was really the
key to the whole project; getting Thunderbolt 3 working meant I could easily
swap between my work computer and my personal computer.  I could use the same
peripherals and configuration (no moving monitors around or swapping input
devices - just one thunderbolt cable).  Ultimately, I was able to get everything
sorted such that my Caldigit TS3 Plus and LG 5k Ultrafine work perfectly on warm
boot (ie - they are not recognized as thunderbolt devices when the Mac Pro first
powers on from a shutdown state, but after being logged in to a user and
rebooted, they work just fine).  This includes hot plugging (hugely important
for me, seeing as I move a Thunderbolt cable from my work machine to my Mac
Pro.  If I had to reboot two or three times in between each of those, it would be incredibly
annoying.  In fact, it would be tempting to just leave my work computer set up.
And if my work computer is set up, I may as well do a little more work...and
that's how I would end up working far too late.  The dangers of working from
home!), brightness/webcam/speakers/mic/rear USB C ports on the LG 5k and all
ports on the Caldigit.  So what was the process?

***** the card

The Gigabyte GC-Titan Ridge PCIe card has two Thunderbolt 3-out ports, and two
DisplayPort-in ports (as I understand it, a single DisplayPort 1.2 cable cannot
carry 5k pixels; internally, the 5k iMac had to combine two DisplayPort streams
over a custom interconnect.  I /think/ that's also what spelled the end for
Target Display Mode, but that's more than a bit of a digression).  To make it
work in the 5,1 Mac Pro requires some finagling in three areas: power, firmware
and drivers.  This process is captured very nicely in some [[https://github.com/ameyrupji/thunderbolt-macpro-5-1/blob/master/GC-TitanRidge.md][great writeups]], and
[[https://forums.macrumors.com/threads/testing-tb3-aic-with-mp-5-1.2143042/page-1][exhaustive forum posts]], but there are a few pitfalls that I'll point out along
the way here.


***** power

Powering the Gigabyte GC-Titan Ridge card is pretty straightforward.  By design,
the included =THB_C= Header Cable would connect to the matching headers on a
Gigabyte Thunderbolt motherboard.  Clearly, we don't have those on the 5,1.
Instead, I jumped the third and fifth pins with a small piece of wire.

#+CAPTION: The small grey wire on the right jumps the third and fifth pin
file:/images/mp_13.jpg

***** firmware

This process is a bit more involved.  Ultimately, we'll be using an EEPROM USB
Programmer to get some custom firmware flashed onto the Titan Ridge.  Reviewing
the manual for your particular USB Programmer is important - the one that I
purchased has a single identifying lead (one red wire) letting you know which is
the first pin of the chip.

#+CAPTION: Note the red wire matching up with the =1= lead
file:/images/mp_14.jpg

I took the housing off of the Titan Ridge card, and clipped the programmer into
position.

To orient yourself on the Titan Ridge card, keep the thunderbolt ports as close
to you as possible, with the PCIe male interface on your right. The matching
first PIN on the chip is the bottom right on both the Blue and Green chips in
this orientation.

#+CAPTION: All wired up
file:/images/mp_15.jpg

With the programmer all plugged in, I pulled down the =flashrom= tool (=brew
install flashrom=), and downloaded the DM2 firmware (available from the
previously linked MacRumors [[https://forums.macrumors.com/threads/testing-tb3-aic-with-mp-5-1.2143042/post-28291766][thread]]).  With the programmer clipped to the blue
chip, I confirmed that everything was working.

#+begin_example
tglynn@Neptune ~ $ flashrom -p ch341a_spi
flashrom v1.2 on Darwin 19.4.0 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
libusb: info [darwin_claim_interface] no interface found; setting configuration: 1
Found Winbond flash chip "W25Q80.V" (1024 kB, SPI) on ch341a_spi.
No operations were specified.
#+end_example


On second run, that =libusb= error disappeared (default is set)

#+begin_example
tglynn@Neptune ~ $ flashrom -p ch341a_spi
flashrom v1.2 on Darwin 19.4.0 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Winbond flash chip "W25Q80.V" (1024 kB, SPI) on ch341a_spi.
No operations were specified.
#+end_example

Then, I backed up the original ROM.

#+begin_example
tglynn@Neptune ~/work/thunderbolt3_flash $ pwd
/Users/tglynn/work/thunderbolt3_flash
tglynn@Neptune ~/work/thunderbolt3_flash $ flashrom -p ch341a_spi -r OriginalFirmware-BlueChip.bin
flashrom v1.2 on Darwin 19.4.0 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Winbond flash chip "W25Q80.V" (1024 kB, SPI) on ch341a_spi.
Reading flash... done.
tglynn@Neptune ~/work/thunderbolt3_flash $ ls
OriginalFirmware-BlueChip.bin
tglynn@Neptune ~/work/thunderbolt3_flash $ file OriginalFirmware-BlueChip.bin
OriginalFirmware-BlueChip.bin: data
tglynn@Neptune ~/work/thunderbolt3_flash $
#+end_example

Then I moved over to the green chip and repeated the same process to back it up.

#+begin_example
tglynn@Neptune ~/work/thunderbolt3_flash $ flashrom -p ch341a_spi -r OriginalFirmware-GreenChip.bin
flashrom v1.2 on Darwin 19.4.0 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Winbond flash chip "W25Q80.V" (1024 kB, SPI) on ch341a_spi.
Reading flash... done.
tglynn@Neptune ~/work/thunderbolt3_flash $ ls
OriginalFirmware-BlueChip.bin  OriginalFirmware-GreenChip.bin
tglynn@Neptune ~/work/thunderbolt3_flash $ file OriginalFirmware-GreenChip.bin
OriginalFirmware-GreenChip.bin: data
#+end_example

With both safely backed up, it was time to flash the custom ROM.  I switched
back to the blue chip yet again.

#+CAPTION: In the orientation described above, the blue chip is on the left
file:/images/mp_16.jpg


Then I wrote the updated firmware.

#+begin_example
tglynn@Neptune ~/work/thunderbolt3_flash $ flashrom -p ch341a_spi -w TitanRidgeNVM23-E64Fr.bin
flashrom v1.2 on Darwin 19.4.0 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Winbond flash chip "W25Q80.V" (1024 kB, SPI) on ch341a_spi.
Reading old flash chip contents... done.
Erasing and writing flash chip... Erase/write done.
Verifying flash... VERIFIED.
#+end_example


For good measure, I ran the verify as well (redundant with the previous commands
flags, but interesting to see).

#+begin_example
tglynn@Neptune ~/work/thunderbolt3_flash $ flashrom -p ch341a_spi -v TitanRidgeNVM23-E64Fr.bin
flashrom v1.2 on Darwin 19.4.0 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Winbond flash chip "W25Q80.V" (1024 kB, SPI) on ch341a_spi.
Verifying flash... VERIFIED.
#+end_example


If you were to say, oh I don't know, not realize the import of the red wire on
the USB programmer and clip onto the chip backwards (not that I have any
experience with that...) fear not!  In my experience, all that will happen is
the negotiation will fail, and the flashing capabilities won't be apparent.

#+begin_example
tglynn@Neptune ~/work/thunderbolt3_flash $ flashrom -p ch341a_spi
flashrom v1.2 on Darwin 19.4.0 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
libusb: info [darwin_claim_interface] no interface found; setting configuration: 1
Found Generic flash chip "unknown SPI chip (REMS)" (0 kB, SPI) on ch341a_spi.
===
This flash part has status NOT WORKING for operations: PROBE READ ERASE WRITE
The test status of this chip may have been updated in the latest development
version of flashrom. If you are running the latest development version,
please email a report to flashrom@flashrom.org if any of the above operations
work correctly for you with this flash chip. Please include the flashrom log
file for all operations you tested (see the man page for details), and mention
which mainboard or programmer you tested in the subject line.
Thanks for your help!
No operations were specified.
#+end_example

Flipping the programmer back around and correctly lining up the pins should sort
that out.

With that, power and firmware were all sorted out.

***** drivers

Interestingly enough, you could stop right here and be most of the way done.
Once those pins are shorted and the custom firmware put into place, thunderbolt
3 works.  It seems that it can only enumerate devices when they're powered on
already, so there is a bit of a silly ritual to get things working.  Starting
with the machine powered off and the thunderbolt 3 device unplugged, power on
the Mac Pro.  Once the Mac Pro is powered on, plug in the Thunderbolt 3 device.
In my experience, the device would power on (the Caldigit's blue power indicator
came on, and the LG 5k even passed video through, working like a regular
monitor), but no ports or devices on the other end of the Thunderbolt device
would work (none of the USB ports on the Caldigit worked, and the
webcam/brightness controls/speaker/mic and USB ports on the LG 5k did not
work).  Rebooting would walk one step further in the chain; in my case, the
Caldigit would work just fine at that point, with every port functioning.  If
the LG 5k was connected to the downstream Thunderbolt 3 port of the Caldigit, it
would take yet another reboot before the next link in the chain would fill in
and the webcam/brightness/usb controls on the LG 5k would all work.  Unplugging
the Thunderbolt 3 cable would reset this dance, breaking the first link in the
chain and forcing me to walk back through all of that.

But that's less than ideal.  And, I'm pleased to tell you, there is a better
solution.  Enter Open Core, and a custom SSDT.  In this field, I think the
Hackintosh community has better documentation (see the [[https://www.tonymacx86.com/threads/success-gigabyte-designare-z390-thunderbolt-3-i7-9700k-amd-rx-580.267551/page-1640#post-2087524][repository of patched
Thunderbolt firmware files]], [[https://www.tonymacx86.com/threads/success-gigabyte-designare-z390-thunderbolt-3-i7-9700k-amd-rx-580.267551/page-1596#post-2085793][the quick comparative analysis of Thunderbolt DROM
and Thunderbolt Config]], [[https://www.tonymacx86.com/threads/success-gigabyte-designare-z390-thunderbolt-3-i7-9700k-amd-rx-580.267551/page-1603#post-2086071][thunderbolt drom decoded]], [[https://www.tonymacx86.com/threads/success-gigabyte-designare-z390-thunderbolt-3-i7-9700k-amd-rx-580.267551/page-1624#post-2086862][and the micro-guide for
gigabyte gc-titan ridge]] for much more detail).  I recognize that may be my own
language limitations (as I understand it, the source of the successful firmware
is a German Hackintosh forum, although I've seen some disputes around who
precisely did the work to hack it together), but in any case, I landed on a
fairly simple configuration.  A single SSDT, added to the ACPI in Open Core.

#+BEGIN_SRC xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>ACPI</key>
    <dict>
        <key>Add</key>
        <array>
            <dict>
                <key>Comment</key>
                <string>GC Titan Ridge HotPlug SSDT</string>
                <key>Enabled</key>
                <true/>
                <key>Path</key>
                <string>SSDT-TBOLT3.aml</string>
            </dict>
        </array>
#+END_SRC

#+begin_example
tglynn@jupiter ~/projects/opencore/my_opencore/EFI/OC (master*) $ shasum -a 256 ACPI/SSDT-TBOLT3.aml
54a5f8fc04e723c838deb63052067c380c68e216d693ca23bf61f6683dc60fb9  ACPI/SSDT-TBOLT3.aml
#+end_example

I'm not going to document the whole Open Core setup here - the [[https://forums.macrumors.com/threads/opencore-on-the-mac-pro.2207814/][wiki entry]] at the
start of the MacRumors forum thread has improved by leaps and bounds since I
first went through this back in April, and it's in fantastic shape now.  Follow
that wiki entry, add in the directive above and pull down the [[https://forums.macrumors.com/threads/testing-tb3-aic-with-mp-5-1.2143042/post-28246620][SSDT-TBOLT3.aml
file]] and you should be all set with Thunderbolt 3.

There is one pitfall that snagged me for /quite/ a while.  The Titan Ridge card
needs to be in slot 4 (as I understand it, it's hardcoded in to the SSDT).  Due
to the shared bandwidth of slot 3 and slot 4, if you have another high bandwidth
card in slot 3, the Titan Ridge card will not work with the SSDT enabled.  In my
experience, when I had my Syba I/O card in slot 3 or a USB 3.2 PCIe card in slot
3, the Titan Ridge would work /without/ the SSDT, but would not be recognized or
initialized if I attempted to load the custom SSDT.  Ultimately, I left slot 3
totally empty and made do with slots 1 (for a graphics card), 2 (for NVMe
storage) and slot 4 (for Thunderbolt 3).

I've skimmed over a whole slew of testing and troubleshooting - alternative
firmwares, spelunking through custom SSDTs with [[https://github.com/acidanthera/MaciASL][MaciASL]], several Open Core
versions, but ultimately over the last few months I've found the flashed card
in slot 4, empty slot 3 and the SSDT linked above in Open Core to be the most
reliable and consistent solution.


**** DONE  macpro build - day 2
:PROPERTIES:
:EXPORT_FILE_NAME: mac-pro-buildlog-04
:EXPORT_DATE: 2020-08-29
:END:

Day two is dedicated to some early annoyance fixes, and some temperature and
performance measurements of the NVMe storage.

***** a tiny fan

With a little more burn in time in a quiet room, I noticed a change in the sound
profile of the Mac Pro.  The addition of the Syba I/O card had added in a
high-pitched, whiny fan noise.  This didn't seem to ramp up and down with
temperatures on the M.2 cards; it was a constant, awful whir.

#+CAPTION: The fan in question
file:/images/mp_12.jpg

I know that NVMe thermal management is a significant problem, but my ambient and
component temperatures within the machine were pretty good (and I /really/ didn't
like that fan noise), so I thought I'd give it a try with the fan unplugged.
The heatsink closed up nicely, and kept the fan cable tidily in place.

With the (thankfully much quieter) machine back up and running, I thought I'd
see if I could push some I/O to the NVMe devices and see how they handled
dissipating the heat.  I also took it as an opportunity to confirm the
performance characteristics of my storage.

#+begin_example
tglynn@jupiter /Volumes/nvme_storage_01/test_temps $ fio --name=randwrite --rw=randwrite --direct=1 --ioengine=posixaio --bs=64k --numjobs=8 --size=4g --runtime=600 --group_reporting
randwrite: (g=0): rw=randwrite, bs=(R) 64.0KiB-64.0KiB, (W) 64.0KiB-64.0KiB, (T) 64.0KiB-64.0KiB, ioengine=posixaio, iodepth=1
...
fio-3.19
Starting 8 processes
randwrite: Laying out IO file (1 file / 4096MiB)
randwrite: Laying out IO file (1 file / 4096MiB)
randwrite: Laying out IO file (1 file / 4096MiB)
randwrite: Laying out IO file (1 file / 4096MiB)
randwrite: Laying out IO file (1 file / 4096MiB)
randwrite: Laying out IO file (1 file / 4096MiB)
randwrite: Laying out IO file (1 file / 4096MiB)
randwrite: Laying out IO file (1 file / 4096MiB)
Jobs: 8 (f=8): [w(8)][100.0%][w=2075MiB/s][w=33.2k IOPS][eta 00m:00s]
randwrite: (groupid=0, jobs=8): err= 0: pid=3544: Thu Apr 16 18:56:50 2020
  write: IOPS=35.5k, BW=2222MiB/s (2329MB/s)(32.0GiB/14750msec)
    slat (usec): min=2, max=185, avg= 7.37, stdev= 3.60
    clat (usec): min=85, max=7605, avg=214.44, stdev=42.70
     lat (usec): min=96, max=7611, avg=221.81, stdev=42.75
    clat percentiles (usec):
     |  1.00th=[  161],  5.00th=[  174], 10.00th=[  182], 20.00th=[  192],
     | 30.00th=[  198], 40.00th=[  206], 50.00th=[  212], 60.00th=[  219],
     | 70.00th=[  227], 80.00th=[  235], 90.00th=[  249], 95.00th=[  262],
     | 99.00th=[  306], 99.50th=[  355], 99.90th=[  498], 99.95th=[  553],
     | 99.99th=[  742]
   bw (  MiB/s): min= 2073, max= 2264, per=100.00%, avg=2229.27, stdev= 7.56, samples=224
   iops        : min=33168, max=36232, avg=35664.32, stdev=120.83, samples=224
  lat (usec)   : 100=0.01%, 250=90.94%, 500=8.95%, 750=0.09%, 1000=0.01%
  lat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%
  cpu          : usr=5.41%, sys=4.33%, ctx=571965, majf=0, minf=204
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,524288,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
  WRITE: bw=2222MiB/s (2329MB/s), 2222MiB/s-2222MiB/s (2329MB/s-2329MB/s), io=32.0GiB (34.4GB), run=14750-14750msec
#+end_example


#+begin_example
tglynn@jupiter /Volumes/nvme_storage_01/test_temps $ fio --name=randwrite --rw=randwrite --direct=1 --ioengine=posixaio --bs=64k --numjobs=8 --size=512m --runtime=600 --group_reporting
randwrite: (g=0): rw=randwrite, bs=(R) 64.0KiB-64.0KiB, (W) 64.0KiB-64.0KiB, (T) 64.0KiB-64.0KiB, ioengine=posixaio, iodepth=1
...
fio-3.19
Starting 8 processes
Jobs: 8 (f=8)
randwrite: (groupid=0, jobs=8): err= 0: pid=3522: Thu Apr 16 18:55:58 2020
  write: IOPS=35.6k, BW=2222MiB/s (2330MB/s)(4096MiB/1843msec)
    slat (usec): min=2, max=127, avg= 6.83, stdev= 3.27
    clat (usec): min=93, max=21151, avg=212.97, stdev=145.17
     lat (usec): min=110, max=21160, avg=219.80, stdev=145.17
    clat percentiles (usec):
     |  1.00th=[  159],  5.00th=[  172], 10.00th=[  180], 20.00th=[  190],
     | 30.00th=[  198], 40.00th=[  204], 50.00th=[  210], 60.00th=[  217],
     | 70.00th=[  223], 80.00th=[  233], 90.00th=[  245], 95.00th=[  260],
     | 99.00th=[  297], 99.50th=[  318], 99.90th=[  465], 99.95th=[  619],
     | 99.99th=[ 1434]
   bw (  MiB/s): min= 2259, max= 2283, per=100.00%, avg=2269.96, stdev= 1.33, samples=24
   iops        : min=36154, max=36538, avg=36313.67, stdev=21.17, samples=24
  lat (usec)   : 100=0.01%, 250=92.19%, 500=7.73%, 750=0.05%, 1000=0.02%
  lat (msec)   : 2=0.01%, 50=0.01%
  cpu          : usr=5.17%, sys=4.42%, ctx=71930, majf=0, minf=189
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,65536,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
  WRITE: bw=2222MiB/s (2330MB/s), 2222MiB/s-2222MiB/s (2330MB/s-2330MB/s), io=4096MiB (4295MB), run=1843-1843msec
#+end_example

Temperatures on the NVMe devices peaked around 52 (C), and dropped back down to
the idle temp of 39 in less than a minute. Those are not worrying temperatures,
but unplugging the Syba's fan does compound my fears around airflow, since the
Syba I/O card rests right up against the GPU, and the GPU exhaust will blow
right across it.  I'm not so sure that the Syba's fan would be able to do much about that
suboptimal situation anyway.  It would still be pulling in the hot exhaust from
the GPU to do whatever cooling it can (and I imagine the GPU fans are moving
much more air than the tiny Syba fan ever could).  But it's worth testing nonetheless.

***** changing slots

Moving the Syba I/O card to slot 3 was trivial (I was worried that there might
be some problems finding the boot drive, but it was a total nonevent).  The
change from slot 2 to slot 3 means the card is now in a PCI Express 1.0 x4 slot,
rather than a PCI Express 2.0 x16 slot.  So the maximum theoretical throughput
of the Syba is now (250 MB/s * 4 * 2) 2000 MB/s (made even slower due to limited
connection from South Bridge, where slots 3 and 4 are connected, to the North
Bridge).  A quick =fio= benchmark proved that change out:

#+begin_example
tglynn@jupiter /Volumes/nvme_storage_01/test_temps $ fio --name=randwrite --rw=randwrite --direct=1 --ioengine=posixaio --bs=64k --numjobs=8 --size=4g --runtime=600 --group_reporting
randwrite: (g=0): rw=randwrite, bs=(R) 64.0KiB-64.0KiB, (W) 64.0KiB-64.0KiB, (T) 64.0KiB-64.0KiB, ioengine=posixaio, iodepth=1
...
fio-3.19
Starting 8 processes
Jobs: 8 (f=8): [w(5),f(1),w(2)][100.0%][w=1503MiB/s][w=24.0k IOPS][eta 00m:00s]
randwrite: (groupid=0, jobs=8): err= 0: pid=943: Fri Apr 17 16:46:54 2020
  write: IOPS=23.8k, BW=1490MiB/s (1562MB/s)(32.0GiB/21994msec)
    slat (nsec): min=2715, max=98380, avg=7062.84, stdev=3011.27
    clat (usec): min=117, max=9036, avg=325.37, stdev=48.69
     lat (usec): min=127, max=9042, avg=332.43, stdev=48.67
    clat percentiles (usec):
     |  1.00th=[  289],  5.00th=[  302], 10.00th=[  310], 20.00th=[  314],
     | 30.00th=[  318], 40.00th=[  318], 50.00th=[  322], 60.00th=[  322],
     | 70.00th=[  326], 80.00th=[  330], 90.00th=[  343], 95.00th=[  355],
     | 99.00th=[  445], 99.50th=[  644], 99.90th=[  668], 99.95th=[  676],
     | 99.99th=[  807]
   bw (  MiB/s): min= 1406, max= 1520, per=100.00%, avg=1491.52, stdev= 2.70, samples=344
   iops        : min=22510, max=24322, avg=23861.98, stdev=43.04, samples=344
  lat (usec)   : 250=0.02%, 500=99.17%, 750=0.80%, 1000=0.01%
  lat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%
  cpu          : usr=3.55%, sys=2.97%, ctx=542369, majf=0, minf=193
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=0,524288,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
  WRITE: bw=1490MiB/s (1562MB/s), 1490MiB/s-1490MiB/s (1562MB/s-1562MB/s), io=32.0GiB (34.4GB), run=21994-21994msec
#+end_example

Temperature was totally unchanged.  The NVMe cards idled around 39, and peaked
under heaviest sustained load around 52.

With no temperature impact and a clear performance change, I decided to keep the
Syba I/O card in slot 2, and run it with the built in fan unplugged.


**** DONE macpro build - day 1
:PROPERTIES:
:EXPORT_FILE_NAME: mac-pro-buildlog-03
:EXPORT_DATE: 2020-05-13
:END:

***** the machine
It begins!  First, we'll verify our day 0 assumptions, and examine the machine
itself.

#+CAPTION: A first peek inside
[[file:/images/mp_02.jpg]]

All told, it's cosmetically /fine/.  I'd love a more pristine chassis (this guy
has definitely been bounced off some rough corners), but it was
relatively clean on the inside.  I blew the machine out with compressed air and
wiped down all of touchable surfaces before really cracking in.

(A small disappointment; it shipped with a generic power cable, and was missing
a drive tray.  I understand lots of shops find it easier to strip the whole tray
out when decommissioning these machines, and keeping track of the original power
cable is well beyond the purview of most IT shops, but I would have preferred to
get all of the original components).

Starts up just fine the first time that I plug it in and hit the power
button. All fans are rotating, optical drive seems to be fully functional as
well.

***** clean install

Let's get ourselves a clean macOS installation first.  We'll follow the Apple
kbase article [[https://support.apple.com/en-us/HT201372][here]] to create a USB 2.0 bootable installer.  Booting to the
installer works just fine and disk utility doesn't complain about re
partitioning the 1 TB internal HDD.  I chose HFS+, since this is a rotational
drive (I'll use APFS for the NVMe installations).

Before I can reinstall High Sierra, I'm prompted for the first firmware update.
It had been a long time since I last ran a firmware update on a Mac Pro; if you
find yourself trying to do it, be patient -  it takes longer than you might
expect.  The optical drive will pop open during the process (to allow you to pop
in a CD with differing firmware, if I recall correctly), so keep an eye out for
the opening and closing of the optical drive.

With the firmware update done and a fresh install of High Sierra completed, it's
time to log in and capture the specs of the machine.

***** the specs

Of note here are the current boot ROM version.  The machine can't boot from an
NVMe drive on this boot ROM, so we'll need to run some more firmware updates
before we get the actual macOS installation setup.


#+begin_example
Hardware Overview:

  Model Name:	Mac Pro
  Model Identifier:	MacPro5,1
  Processor Name:	Quad-Core Intel Xeon
  Processor Speed:	2.4 GHz
  Number of Processors:	2
  Total Number of Cores:	8
  L2 Cache (per Core):	256 KB
  L3 Cache (per Processor):	12 MB
  Memory:	16 GB
  Boot ROM Version:	MP51.0089.B00
  SMC Version (system):	1.39f11
  SMC Version (processor tray):	1.39f11
  Serial Number (system):	<REDACTED>
  Serial Number (processor tray):	<REDACTED>
  Hardware UUID:	<REDACTED>



ATI Radeon HD 5770:

  Chipset Model:	ATI Radeon HD 5770
  Type:	GPU
  Bus:	PCIe
  Slot:	Slot-1
  PCIe Lane Width:	x16
  VRAM (Dynamic, Max):	1024 MB
  Vendor:	AMD (0x1002)
  Device ID:	0x68b8
  Revision ID:	0x0000
  ROM Revision:	113-C0160C-155
  VBIOS Version:	113-C01601-103
  EFI Driver Version:	01.00.436
  Displays:
24G1WG4:
  Resolution:	1920 x 1080 (1080p FHD - Full High Definition)
  UI Looks like:	1920 x 1080 @ 60 Hz
  Framebuffer Depth:	24-Bit Color (ARGB8888)
  Main Display:	Yes
  Mirror:	Off
  Online:	Yes
  Rotation:	Supported
  Automatically Adjust Brightness:	No
  Connection Type:	DisplayPort



Memory Slots:

  ECC:	Enabled
  Upgradeable Memory:	Yes

DIMM 1:

  Size:	8 GB
  Type:	DDR3 ECC
  Speed:	1066 MHz
  Status:	OK
  Manufacturer:	0x857F
  Part Number:	0x463732314755363746393333334700000000
  Serial Number:	-

DIMM 2:

  Size:	Empty
  Type:	Empty
  Speed:	Empty
  Status:	Empty
  Manufacturer:	Empty
  Part Number:	Empty
  Serial Number:	Empty

DIMM 3:

  Size:	Empty
  Type:	Empty
  Speed:	Empty
  Status:	Empty
  Manufacturer:	Empty
  Part Number:	Empty
  Serial Number:	Empty

DIMM 4:

  Size:	Empty
  Type:	Empty
  Speed:	Empty
  Status:	Empty
  Manufacturer:	Empty
  Part Number:	Empty
  Serial Number:	Empty

DIMM 5:

  Size:	8 GB
  Type:	DDR3 ECC
  Speed:	1066 MHz
  Status:	OK
  Manufacturer:	0x857F
  Part Number:	0x463732314755363746393333334700000000
  Serial Number:	-

DIMM 6:

  Size:	Empty
  Type:	Empty
  Speed:	Empty
  Status:	Empty
  Manufacturer:	Empty
  Part Number:	Empty
  Serial Number:	Empty

DIMM 7:

  Size:	Empty
  Type:	Empty
  Speed:	Empty
  Status:	Empty
  Manufacturer:	Empty
  Part Number:	Empty
  Serial Number:	Empty

DIMM 8:

  Size:	Empty
  Type:	Empty
  Speed:	Empty
  Status:	Empty
  Manufacturer:	Empty
  Part Number:	Empty
  Serial Number:	Empty
#+end_example

We're definitely not running the stock RAM (the OWC sticker in the earlier
picture was a bit of a tip off there), but it's good to hang on to some known
good memory for slot testing and troubleshooting.  Ultimately, the goal is to
be able to isolate any failures component by component, following the flow of
signal and power, until the source of any problem is obvious.  The 8 gig OWC
DIMMs can serve that purpose quite well in the future.


***** baseline performance

Let's capture what this machine can do before we start improving it.  I'm going
to use synthetic benchmarks as a short hand for performance because it's simple
and straightforward; actually computing performance is anything but that.  At
some point I'll probably write up my performance testing manifesto, but in the
mean time, I'm going to say this: synthetic benchmarks can be a useful shorthand
for some performance characteristics in well understood problem spaces.  I'm
going to use them here because it'll be fun to see the numbers go up.

****** geekbench 5, cinebench 20

Sitting next to the machine while it runs the [[https://www.geekbench.com][Geekbench 5]], I'm struck by how
little change there is in the pitch and volume of the fans.  It's not a silent
machine by any stretch of the imagination, but it's a consistent white noise
that's not particularly distracting.  It's not a long test (4 or 5 minutes to
complete), so that could certainly change if it ran for longer, but all told, a
good first impression for usability during compute tasks.

Note again this is running with the original pair of Xeon 5620's (2 processors,
each with 4 cores and 8 threads) with 16 gigs (2x8) of 1066 MHz DDR3 memory.
The graphical benchmarks will be testing the ATI Radeon HD 5770.

| Benchmark                    | Result |
|------------------------------+--------|
| Geekbench 5 CPU, Single Core |    485 |
| Geekbench 5 CPU, Multi Core  |   3160 |
| Geekbench 5 Compute (OpenCL) |   1005 |
| Cinebench                    |   1640 |

Nothing surprising there.  Our single core performance is pretty dismal.  Multi
core performance puts us just below the 4 core 8 thread 2.6 GHz Intel Core
i7 6700.  Graphical performance...makes sense for a card from a previous decade.

***** stability and load

I'd like to check out the general stability of the machine as well, before I
start making changes and introducing potential chaos.  My stability checks here
are pretty simple; I'll open up eight instances of terminal, each redirecting
the =yes= command to =/dev/null=.  That'll keep threads of execution running at
clock rate along each of the eight real physical cores.  And I'll just leave
that running.  Ideally, we won't hear a huge change in fan volume (if I were
really good about this, I'd actually measure the ambient and specific volumes
during this test, but considering the myriad of other noises in and around my
home, I'm totally comfortable with the less scientific approach of playing it by
ear), and the machine should be responsive throughout the test.

All told, I let this run for about 6 hours, hopping on occasionally to open a
browser window or move some Finder windows around.  No issues with
responsiveness and it was still running just fine at the tail end of it.  Not
necessarily a perfect bill of health, but a pretty good indicator of stability.
Funnily enough, my work laptop (2015 15 inch Macbook Pro) is louder running
builds than the Mac Pro.

***** installing the rx 580

This machine has such lovely little touches.  The PCI card locking bar,
controlled with a button press from an enclosure around the central system fan
is quite clever.  And of course, the PCI slot cover plate has good sized,
grippable thumb screws (and they're captured! why would they not be?) that
really put to shame so many other generic cases.  I understand that case design
and ergonomics have been improving in general in the PC industry, but many of
the machines that I've worked on before had terribly fussy screws holding the
PCI slot covers in place.  This simple place is such a nice touch.

#+CAPTION: Easy to turn by hand, with Phillips slots for undoing overzealous tightening
[[file:/images/mp_03.jpg]]

Power for the RX 580 is an easy story.  Just replace the 5770's mini six pin to
six pin with a two mini six pin to eight pin cable.

#+CAPTION: Two mini six pin to eight pin cable
[[file:/images/mp_04.jpg]]


Out comes the 5770

#+CAPTION: ATI Radeon HD 5770
[[file:/images/mp_05.jpg]]


And in goes the RX 580

#+CAPTION: RX 580
[[file:/images/mp_06.jpg]]

#+CAPTION: The installed 580
[[file:/images/mp_07.jpg]]

I'll confess, I'm a little concerned at this point about airflow.  Looking at
the NVMe card, it's going to be flush right up against the RX 580.  Heat might
be a concern here.

***** firmware updates

Now that there's a Metal capable GPU installed, the Mojave installer will launch
(without a Metal capable GPU, the unpatched installer won't run).  I'm not
actually interested in the install at this point, since we'll be installing to
the NVMe drive, but the firmware updater is bundled into the 10.14.6 combo
installer.

Since the RX 580 isn't mac flashed (this era of Macs ran non standard extensible
firmware interface (EFI), not to be confused with the now ubiquitous UEFI.  The
generic RX 580 doesn't know how to display video during the EFI stage of
booting, so no video at the boot prompt), I'll be flying blind here.  Flashing
power LED, long tone, and the optical drive opening and closing are the only
indicators to the process.

Coming back into the operating system, we've got the right firmware now to boot
from an NVMe drive.

#+CAPTION: The sharp eyed reader will see upgraded CPUs and memory here; I had to take this screenshot after the fact
[[file:/images/mp_08.jpg]]

Now it's time for the NVMe cards and the real Mojave installation.

***** nvme card

#+CAPTION: Syba I/O Crest
[[file:/images/mp_09.jpg]]

These are some positively /tiny/ standoffs.  Screwing them in from the bottom is
fussy work.  There may or may not have been a few frantic minutes waving a
flashlight across my floor to find the telltale flicker of a dropped standoff
screw.

#+CAPTION: Look at how tiny they are!
[[file:/images/mp_10.jpg]]

I foolishly thought that using the provided screw driver was a good idea.
Definitely not.  Switching to a real magnetized jeweler's set made getting the
m.2 drives installed much easier.

It's a tight fit against the RX 580.  They are cheek to jowl in there, and I'll
need to keep an eye on temperatures.

#+CAPTION: The Syba installed
[[file:/images/mp_11.jpg]]


Both drives are recognized immediately.  A quick trip to disk utility leaves us
with a GUID partition scheme for an APFS volume that will serve as the target of
the Mojave installation.

Nothing eventful to the install; kick it off, get some coffee, and come back to
a clean install of Mojave.

At this point, I'm done with the original 1 TB rotational drive (at close to 10
years old, I wouldn't want to rely on it for anything).  I'll put it in my big
box of just-in-case parts for the Mac Pro joining the 5770, to be dusted off in case of a need to
return to High Sierra.


***** revisiting gpu performance

With the newly installed card, let's take a loot at the changes in GPU
performance.

| Benchmark                    | Result |
|------------------------------+--------|
| GeekBench 5 Compute (OpenCL) |  39043 |
| GeekBench 5 Compute (Metal)  |  42658 |


Almost a 40x improvement; not too shabby at all.

**** DONE macpro build - day 0
:PROPERTIES:
:EXPORT_FILE_NAME: mac-pro-buildlog-02
:EXPORT_DATE: 2020-05-12
:END:

Now that we now what we're going to try to do here and why, let's formulate some
kind of plan for this project.

***** the plan

I'm going to start with the lowest spec 2 processor tray.  I might have been
able to find a better deal on a single processor machine and then source a dual
proc CPU tray, but from a cursory search of ebay and craigslist, that might take
a while, and I'm a little concerned about extra shipping cycles and part
availability.  Ultimately, I landed on:

=Apple Mac Pro 5,1 MC561LL/A (2010) 8 Core/16GB/1TB/ ATI Radeon 5770=

(Note that the =8 Core= specification spells out two quad core CPUs)

More details around that particular Mac available [[https://everymac.com/systems/apple/mac_pro/specs/mac-pro-eight-core-2.4-mid-2010-westmere-specs.html][here]].

Most of those specs are stock - that is the GPU that shipped with that machine in
2010, which is important for getting the bootscreen and will be a useful thing to keep
around for troubleshooting, and a 1 TB 7200 RPM rotating drive also could well
be original.  The RAM isn't stock (the original machine shipped with six 1 GB
DIMMs), but that's a super common upgrade, and I don't imagine we'll need the
factory RAM for anything.

From the listing, the machine is running High Sierra.  Unclear which firmware it
will ship with.

/What's the plan?/

There are a few interlocking steps here. To upgrade from High Sierra to Mojave,
I'll need a metal capable graphics card.  Switching to a metal capable graphics
card probably means giving up the boot screen (there are flashed firmware cards,
and folks who offer firmware flashing as a service, but I don't think it's worth
it for my use case).  I'll likely end up running [[https://github.com/acidanthera/OpenCorePkg][OpenCore]] anyway to allow me to
update to Catalina with hardware acceleration and Thunderbolt 3 support, so the
boot screen isn't a big loss.

So I need a metal capable GPU.  I've gone back and forth a bit, trying to decide
between the 5700 XT and the Radeon VII.  The 5700 XT is a newer Navi card, with
some significant benefits to power draw and cooling.  They're both 7nm
processes, but the Radeon VII is much more power hungry.  To the Radeon VII's
credit, it appears to benchmark better than the 5700 XT in several performance
characteristics, and, most importantly, is supported in both Mojave and Catalina
(the 5700XT requires a relatively new version of Catalina).  Both would likely
require modifying my power supply.  In the end, I landed on the Radeon VII for
the slightly increased flexibility, slightly better performance and slightly
better price.  I will need an interim card, a card that runs in both High Sierra
and Mojave so that I can perform the litany of firmware updates and the crucial
update from High Sierra to Mojave.  It will also take some time to get the parts
required for the power supply mod, so I'll be using an MSI RX 580 Armor 8G OC
with a dual mini 6 pin to 8 pin power adapter in the interim.

I'll keep the 1 TB HDD on High Sierra so that I can use the original 5770 (once
I upgrade to Mojave, the 5770 won't be able to boot the OS).  The plan starts to
look like:

1. Document and benchmark the initial system
2. Run High Sierra firmware updates, wipe 1 TB HDD and clean install High Sierra
3. Install Radeon RX 580.  Power the card with a dual mini 6 pin to single 8 pin
   adapter.
4. Run all firmware updates bundled in the Mojave installer. This will bring the
   machine's firmware to =144.0.0.0.0=, and crucially adds the ability to boot
   off of NVMe drives.
5. Install PCIe NVMe bifurcation Riser and boot NVMe drive in slot 2
6. Install Mojave to NVMe drive.  Remove 1 TB HDD, store in safe place.
7. Flash Titan Ridge thunderbolt 3 card
8. Install Thunderbolt 3 card
9. Upgrade CPUs
10. Upgrade memory
11. Perform [[http://blog.greggant.com/posts/2018/05/07/definitive-mac-pro-upgrade-guide.html#pixlas][pixlas mod on power supply]]
12. Install Radeon VII
13. Upgrade optical drive to Blu-ray drive
14. Install Windows 10 (to either SATA SSD or, if I've installed OpenCore, to
    the second NVMe drive)

***** componentry

This will leave me with a machine that looks like (from the bottom of the box
up):

| Location            | Component                                                                        |
|---------------------+----------------------------------------------------------------------------------|
| CPU Tray            | 2 x Xeon 5690 (32 nm 6 core, 12 thread 3.46-3.73 GHz processors)                 |
| Memory Slots        | 96 gigabytes (6 x 16) DDR3 ECC memory at 1333 MHz                                |
| PCIe Slot 1         | Radeon VII                                                                       |
| PCIe Slot 2         | Syba I/O Crest SI-PEX40129 Dual M.2 NVMe Bifurcation Riser                       |
| Syba Slot 1         | 1 TB Samsung 970 Evo NVMe (macOS boot drive)                                     |
| Syba Slot 2         | 1 TB Samsung 970 Evo NVMe (Windows 10)                                           |
| PCIe Slot 3         | Sonnet Allegro USB-c 4 port PCIe card                                            |
| PCIe Slot 4         | Gigabyte GC-Titan Ridge Thunderbolt 3 card                                       |
| Drive Bay 1         | 8 TB Seagate HDD (Time Machine, EFI host for OpenCore)                           |
| Drive Bay 2         | 3 TB WD Red HDD (Mac rotational storage)                                         |
| Drive Bay 3         | 3 TB WD Red HDD (Windows rotational storage)                                     |
| Drive Bay 4         | 3 TB WD Red HDD (Vanilla Mojave bootable snapshot, for OpenCore troubleshooting) |
| Optical Drive Bay 2 | Empty                                                                            |
| Optical Drive Bay 1 | LG WH16NS60 16x Internal Blu-ray BDXL M-Disc Drive (flashed for UHD rips)        |


***** references

- [[http://blog.greggant.com/posts/2018/05/07/definitive-mac-pro-upgrade-guide.html][The Definitive Classic Mac Pro Upgrade Guide]] - just an outstanding
  resource. Lots of information, lots of links.  This single post provides
  almost all of required info for this project.

- [[https://forums.macrumors.com/threads/testing-tb3-aic-with-mp-5-1.2143042/][MacRumors thread, Thunderbolt 3]] - ever evolving, source of some great
  information about flashing the Titan Ridge for use in the cMP 5,1

- [[https://forums.macrumors.com/threads/opencore-on-the-mac-pro.2207814/?view=reaction_score][OpenCore on Legacy Apple Hardware]] - another fantastically maintained wiki
  post.  Improved by leaps and bounds even as I'm writing this up.

- [[https://github.com/ameyrupji/thunderbolt-macpro-5-1][Thunderbolt Mac Pro Early 2009]] - good summation of the flashing process, with
  some very useful pictures and links

- [[https://www.makemkv.com/forum/viewtopic.php?f=16&t=19928&sid=66451896270b9a530b25b882ed3aad55][Flashing for 4k UHD]] - not cMP 5,1 specific, but great information on flashing
  the Blu-ray drive for 4k UHD rips

- [[https://www.tonymacx86.com/threads/success-gigabyte-designare-z390-thunderbolt-3-i7-9700k-amd-rx-580.267551/][Gigabyte designare flashing]] - the micro guides provide a ton of useful
  background information, and tend to be a little more technical in their
  explanations.  Useful for trying to understand /why/ some steps are required.


**** DONE macpro build - what and why
:PROPERTIES:
:EXPORT_FILE_NAME: mac-pro-buildlog-01
:EXPORT_DATE: 2020-05-12
:END:

In March of 2020, I went looking for a project.  I was looking for something
that I could focus some extra time and energy on (that /wasn't/ just frantically
refreshing news sites).  I was working from home full time for the first time in
my life, a change which necessitated some alterations to my workspace.  Graduate
school was finished, so I could afford some instability on my personal machine,
and the 5k iMac that had served as the anchor of my home computing life was now
in the way (I couldn't use it for work, so it ended up awkwardly shunted aside
most days, and moving it back into place every night was /just/ annoying enough
to be untenable.  It was easier to just leave my work machine plugged in and
running, but /that/ lead to the temptation to do juuuust a little more work
whenever I sat down at my desk; you can imagine the impact that had on work-life
balance).

Enter the 5,1 Mac Pro.

***** the cheese grater

The 5,1 Mac Pro, released in 2010, with a minor spec bump shipped in 2012 and
ultimately replaced by late 2013's trash can, is a very special machine.  Due to
the design choices (and expense) of the models that replaced it, it's had a long
and vibrant life as an expandable, flexible, workstation that can be kitted out
for a variety of use cases.  It holds a special place in my heart as the most
powerful machine Apple was shipping during my time as a Genius; it was the most
complicated machine to troubleshoot, given the flexibility and complexity of its
internals, but it was always a thrill to see one sidle up to the bar.  It was a
machine that /did work/ (or at least, purported to. I fully recognize the myth
of the Mac Pro, which was always more costly than it had any right to be).

Could it be my 2020 computer?

#+CAPTION: cMP 5,1
[[file:/images/mp_01.jpg]]

***** what's the goal?

What am I trying to do here, exactly?  I'm looking to wrangle up a Mac desktop,
responsive enough for day to day use, with enough compute and memory to handle
my polyglot programming (virtualization and containerization, some Go, a
smattering of C++/Clojure/Swift/Python, depending on what I'm picking at on a
particular day), and the graphical power to run the handful of games (some
Blizzard titles, Total War: Warhammer and its sequels, Tabletop Simulator).

I'm loosely describing my requirements as: a desktop,  running macOS, built by
Apple.


/Why a desktop?/

In my experience, laptops add a thin layer of unreliability when being used
permanently docked at a desk.  Peripheral negotiation is often fussy, cooling
can be a problem, and ultimately it feels to me like a misuse of the object.
Look at a laptop; it's fundamentally designed for portability. Using it
permanently tethered feels like hammering nails in with the back end of a
screwdriver.

/Why macOS?/

Windows is a tire fire.  The software ecosystem is a Hieronymus Bosch style
rhizome of misery and suffering, and software development on Windows outside of
the Microsoft ecosystem just sucks.  That's all a deliberately inflammatory
description, but it captures how I feel (and the bulk of my experience trying to
develop for Linux systems on Windows in my previous job).  Window management is
remedial (whoever thought full screen and half screen splits were a good idea,
and parasitically infected other operating systems with that idea should be
tried at the Hague), keyboard shortcuts across the OS for text wrangling suck,
and Emacs on Windows suffers from all sorts of painful compromises.

A more measured answer to "Why not Windows?" is that I don't have room in my brain at the moment
for a detailed enough mental model of the foibles and pit traps of Windows 10.  I'm
not particularly interested in building that model, to be totally honest, since I
find the essential primitives of Windows as an operating system (the registry?
really?) and the user punishing choices (adware in the start menu, user hostile
updates) alien and off putting.  It's the only way to play PC games, so I'll
always have it installed somewhere in the house, but I'd like it as cordoned off
as possible.

The desktop experiences of the non-macOS *nixs are unpleasant for me. Window
management and keyboard shortcuts tend to ape Windows out of the box (yes, there
are distros and customization paths to mimic macOS, but they're never quite 100%
reliable in my experience).  I'll continue to happily run Linux and BSD servers, both in
the house on a handful of headless machines and in VPS's, but for a desktop
machine macOS is the best choice for me.

/Why not a Hackintosh?/

Given the decision to run macOS and the computational/GPU requirements, an
obvious question would be "Why not build a Hackintosh?" OpenCore has come a long
way, the community is active and communicative, AMD has some rad chip offerings
bringing high core counts way down in price - there are a lot of compelling
reasons to build a Hackintosh.  I've done it before, almost half a decade ago,
and found Clover pretty straightforward to configure, and the resulting machine
was powerful and flexible.  But honestly, I've built more than enough PCs.  It's
boring, in many ways, and I don't think building a generic PC and installing
macOS on it would be the engaging project that I'm looking for amidst all of
this chaos.


I have a great deal of affection for the 5,1 Mac Pro.  The high core count, high
memory configuration is surprisingly effective in 2020, and fits my use cases
especially well.  Most intriguingly, the vibrant Mac Pro community has made huge
leaps in recent months, bringing Catalina support, hardware acceleration and,
most importantly to me, Thunderbolt 3.  Thunderbolt support would mean one cable
to plug in my work laptop during the day, and a single cable moving over to
switch to my main machine outside of work.
